
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recipe Widget</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root { --bg:#0b0c0f; --card:#151922; --text:#e8ecf1; --muted:#98a2b3; --accent:#8b5cf6; --accent-2:#22d3ee; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;background:linear-gradient(120deg,var(--bg),#0e1117);color:var(--text);display:grid;place-items:center;min-height:100vh}
    .wrap{width:min(880px,92vw);padding:24px}
    .card{background:linear-gradient(180deg,var(--card),#11151d);border:1px solid #1f2937;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
    header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid #1f2530}
    header h1{font-size:18px;margin:0;letter-spacing:.3px}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#0a0a0a;transition:transform .06s ease;box-shadow:0 6px 18px rgba(72,84,243,.25)}
    .btn:active{transform:translateY(1px)}
    .content{display:grid;grid-template-columns:1fr 1fr;gap:18px;padding:18px}
    .meta{display:grid;gap:10px}
    .title{font-size:22px;line-height:1.2;margin:0}
    .muted{color:var(--muted);font-size:13px}
    .imgwrap{position:relative;border-radius:16px;overflow:hidden;border:1px solid #1f2530}
    .imgwrap a{display:block}
    .imgwrap img{width:100%;height:100%;object-fit:cover;display:block;aspect-ratio:16/10}
    .skeleton{background:linear-gradient(90deg,#1b2230 25%,#253043 37%,#1b2230 63%);background-size:400% 100%;animation:shimmer 1.25s infinite}
    @keyframes shimmer { 0%{background-position:100% 0} 100%{background-position:0 0} }
    .toolbar{display:flex;gap:10px;align-items:center}
    .small{font-size:12px}
    .badge{padding:4px 8px;border:1px solid #243044;border-radius:999px}
    footer{padding:0 20px 18px;color:var(--muted);font-size:12px}
    .error{color:#fca5a5}
    .list{display:flex;flex-wrap:wrap;gap:8px}
    .hidden{display:none}
    @media (max-width:760px){ .content{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="recipe-widget">
      <header>
        <h1>ğŸ³ Recipe Widget</h1>
        <div class="toolbar">
          <span class="small badge" title="é”®ç›˜å¿«æ·é”®">æŒ‰ R éšæœº</span>
          <button id="randomBtn" class="btn">éšæœºæ¥ä¸€ä¸ª</button>
        </div>
      </header>

      <div class="content">
        <div class="imgwrap skeleton" id="imgSkeleton"></div>
        <div class="meta">
          <h2 class="title" id="title">å‡†å¤‡ä¸­â€¦</h2>
          <p class="muted" id="helper">ç‚¹å‡»å›¾ç‰‡å³å¯åœ¨æ–°æ ‡ç­¾æ‰“å¼€åŸå§‹ Recipeã€‚</p>
          <div class="list" id="issues" aria-live="polite"></div>
        </div>
      </div>
      <footer>
        <span>æ•°æ®æ¥æºï¼š<code>data/recipes.csv</code>ï¼ˆéœ€æ”¾åœ¨åŒä»“åº“ï¼ŒåŒåŸŸåä¸‹ï¼‰ã€‚</span>
      </footer>
    </div>
  </div>

  <!-- PapaParse CSV è§£æå™¨ï¼ˆé›¶ä¾èµ–ï¼‰ -->
    <!-- PapaParse CSV è§£æå™¨ï¼ˆé›¶ä¾èµ–ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"
          onerror="(function(){var s=document.createElement('script');s.src='https://unpkg.com/papaparse@5.4.1/papaparse.min.js';document.head.appendChild(s);})();">
  </script>
  <script>
  (function(){
    // ç­‰å¾… PapaParse å¯ç”¨ï¼ˆå¤„ç† CDN/SRI ç­‰åŠ è½½å¤±è´¥åœºæ™¯çš„å…œåº•ï¼‰
    async function waitForPapa(timeout=4000){
      const t0 = (typeof performance!=='undefined' && performance.now)?performance.now():Date.now();
      while(!(window && window.Papa)){
        await new Promise(r=>setTimeout(r,120));
        const now = (typeof performance!=='undefined' && performance.now)?performance.now():Date.now();
        if(now - t0 > timeout) throw new Error('PapaParse æœªåŠ è½½ï¼ˆè¯·æ£€æŸ¥ç½‘ç»œæˆ–å¤–é“¾è„šæœ¬ï¼‰');
      }
      return window.Papa;
    }

    const CSV_PATH = 'data/recipes.csv'; // ä½ å¯ä»¥æ”¹æˆ './recipes.csv'ï¼Œä½†æ¨èæ”¾åˆ° data/ ç›®å½•

    const el = {
      btn: document.getElementById('randomBtn'),
      title: document.getElementById('title'),
      helper: document.getElementById('helper'),
      issues: document.getElementById('issues'),
      imgSkeleton: document.getElementById('imgSkeleton')
    };

    /** å°å·¥å…· **/
    const $ = (tag, attrs={},{text}) => {
      const n = document.createElement(tag);
      for (const k in attrs) n.setAttribute(k, attrs[k]);
      if (text) n.textContent = text;
      return n;
    };

    const state = {
      rows: [],
      lastIdx: -1
    };

    function showIssues(messages){
      el.issues.innerHTML = '';
      (messages||[]).forEach(m=> el.issues.appendChild($("span",{class:"badge"},{text:m})))
    }

    function pickRandom(){
      if(!state.rows.length){ showIssues(["æ²¡æœ‰å¯ç”¨æ•°æ®"]); return; }
      let idx; // é¿å…è¿ç»­ä¸¤æ¬¡åŒä¸€æ¡
      do { idx = Math.floor(Math.random()*state.rows.length); } while(state.rows.length>1 && idx===state.lastIdx);
      state.lastIdx = idx;
      const r = state.rows[idx];
      renderRecipe(r);
    }

    function validUrl(u){
      try { new URL(u); return true; } catch { return false; }
    }

    function renderRecipe(r){
      const { title, image_url, recipe_url } = r;
      el.title.textContent = title || 'ï¼ˆæœªå‘½å Recipeï¼‰';
      showIssues([]);

      // é‡æ–°æ„å»ºå›¾ç‰‡åŒºåŸŸ
      const wrap = document.createElement('div');
      wrap.className = 'imgwrap';
      const linkOk = validUrl(recipe_url);
      const imgOk  = validUrl(image_url);

      const img = new Image();
      img.alt = title || 'recipe image';
      img.decoding = 'async';
      img.loading = 'eager';
      img.referrerPolicy = 'no-referrer'; // æŸäº›ç«™ç‚¹ç¦æ­¢çƒ­é“¾æ—¶æœ‰å¸®åŠ©
      img.src = imgOk ? image_url : '';

      const content = linkOk ? $('a',{href: recipe_url, target:'_blank', rel:'noopener noreferrer'}) : document.createElement('div');
      content.appendChild(img);
      wrap.appendChild(content);

      // skeleton -> image æ›¿æ¢
      el.imgSkeleton.replaceWith(wrap);
      el.imgSkeleton = wrap;

      const warn = [];
      if(!imgOk) warn.push('å›¾ç‰‡ URL æ— æ•ˆ');
      if(!linkOk) warn.push('Recipe é“¾æ¥æ— æ•ˆ');
      if(warn.length) showIssues(warn);
    }

    async function loadCsv(){
      await waitForPapa();
      // é¿å…ç¼“å­˜ï¼ˆcommit å GitHub Pages CDN å¯èƒ½ç¼“å­˜ä¸€ä¼šå„¿ï¼‰
      const url = `${CSV_PATH}${CSV_PATH.includes('?')?'&':'?'}t=${Date.now()}`;
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error('CSV åŠ è½½å¤±è´¥ï¼š'+res.status);
      const text = await res.text();
      const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
      if(parsed.errors?.length){ console.warn(parsed.errors); }

      // ç»Ÿä¸€å­—æ®µåï¼štitle, image_url, recipe_url
      const rows = (parsed.data||[]).map(row=>({
        title: (row.title || row.Title || row.name || '').trim(),
        image_url: (row.image_url || row.image || row.img || '').trim(),
        recipe_url: (row.recipe_url || row.url || row.link || '').trim()
      }))
      .filter(r => r.title && (r.image_url || r.recipe_url));

      if(!rows.length) throw new Error('CSV æ²¡æœ‰è§£æåˆ°æœ‰æ•ˆæ•°æ®ï¼ˆè‡³å°‘éœ€è¦ title ä¸ä¸€ä¸ª URL å­—æ®µï¼‰');
      state.rows = rows;
    }

    function bindUI(){
      el.btn.addEventListener('click', pickRandom);
      window.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='r'){ pickRandom(); }});
    }

    (async function init(){
      try{
        bindUI();
        el.title.textContent = 'æ­£åœ¨åŠ è½½ CSVâ€¦';
        await loadCsv();
        el.title.textContent = 'åŠ è½½å®Œæˆï¼Œç‚¹â€œéšæœºæ¥ä¸€ä¸ªâ€æˆ–æŒ‰ R';
        pickRandom();
      }catch(err){
        console.error(err);
        el.title.textContent = 'åŠ è½½å¤±è´¥';
        showIssues([String(err.message||err)]);
      }
    })();
  })();
  </script>
</body>
</html>

