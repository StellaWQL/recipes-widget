
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/svg+xml" href="./favicon.svg">
  <title>THE RAVEN.</title>

  <!-- ReadWidget ä¾èµ–ï¼šå…ˆ JSZip å epub.js -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://unpkg.com/epubjs/dist/epub.min.js"></script>

  <style>
    :root{
      --bg:#0a0a0c; --bg-grad1:#0f0e13;
      --veil1:rgba(198,169,105,.08); --veil2:rgba(122,31,61,.10);
      --panel:#141018; --panel-2:#0f0b13;
      --text:#eee7db; --muted:#b8b0a2; --stroke:#2b2330;
      --accent:#c6a969; --accent2:#9b7b3a; --danger:#7a1f3d; --link:#d7c08a;
      --shadow:0 22px 50px rgba(0,0,0,.6);
      --shadow-sm:0 12px 28px rgba(0,0,0,.45);

      --serif:
        "Iowan Old Style","Palatino Linotype","Book Antiqua",Georgia,
        "Times New Roman","Times",
        "Noto Serif","Noto Serif SC","Noto Serif TC",
        "Source Han Serif SC","Source Han Serif TC",
        "Songti SC","STSong",
        "Hiragino Mincho ProN","Hiragino Mincho Pro","Yu Mincho",
        "PMingLiU","MingLiU",serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1000px 700px at 12% -10%, var(--veil1), transparent 55%),
        radial-gradient(900px 600px at 110% 8%,  var(--veil2), transparent 60%),
        linear-gradient(120deg, var(--bg), var(--bg-grad1));
      color:var(--text);
      font-family:var(--serif);
      overflow:hidden; letter-spacing:.2px;
      font-variant-ligatures:normal; font-feature-settings:"liga" 1,"kern" 1;
      text-rendering:optimizeLegibility; -webkit-font-smoothing:antialiased;
    }

    .topbar{position:fixed; inset:12px 12px auto 12px; background:linear-gradient(180deg,var(--panel),var(--panel-2));
      border:1px solid var(--stroke); border-radius:14px; display:flex; align-items:center; gap:10px;
      padding:8px 10px; z-index:10000; box-shadow:var(--shadow-sm)}
    .btn{appearance:none; border:0; border-radius:12px; padding:8px 12px; cursor:pointer; font-weight:800; letter-spacing:.3px;
      color:#160e10; background:linear-gradient(180deg,var(--accent),#b28b4a); box-shadow:0 10px 22px rgba(198,169,105,.28);
      transition:filter .12s ease, transform .05s ease}
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:linear-gradient(180deg,#1b141b,#130f15); color:var(--text); box-shadow:none; border:1px solid var(--stroke)}
    .btn.danger{background:linear-gradient(180deg,#8d2647,var(--danger)); color:#f8eaea}
    .hint{color:var(--muted); font-size:12px; margin-left:6px}

    #board{position:absolute; inset:0; padding:64px 16px 16px 16px}

    .widget{position:absolute; top:100px; left:100px; width:360px; min-width:260px; max-width:560px;
      background:linear-gradient(180deg, var(--panel), #0c0a10); border:1px solid var(--stroke); border-radius:16px; box-shadow:var(--shadow); overflow:hidden}
    .widget.resizable{resize:both}

    /* æç®€ headerï¼šåªæœ‰æ ‡é¢˜ï¼›ç‚¹å‡»æ ‡é¢˜=å…³é—­ï¼›hover å¾®å…‰ */
    .w-header{position:relative; cursor:grab; user-select:none; background:linear-gradient(180deg,#1a1420,#100c14);
      padding:10px 12px; border-bottom:1px solid var(--stroke); display:flex; align-items:center; justify-content:center}
    .w-title{font-size:15px; font-weight:900; letter-spacing:.35px; transition:filter .15s ease, text-shadow .15s ease, color .15s ease, transform .05s ease; cursor:pointer}
    .w-title:hover{color:#f6ead0; text-shadow:0 0 6px rgba(198,169,105,.45), 0 0 14px rgba(122,31,61,.35); filter:brightness(1.06)}
    .w-title:active{transform:translateY(1px)}

    .w-body{padding:12px; display:grid; gap:10px}
    .w-footer{padding:10px 12px; border-top:1px solid var(--stroke); color:var(--muted); font-size:12px}

    .figure{position:relative; display:block; width:100%; border-radius:12px; border:1px solid var(--stroke); overflow:hidden;
      background:repeating-linear-gradient(45deg, rgba(255,245,230,.04) 0 6px, rgba(0,0,0,.02) 6px 12px), radial-gradient(500px 300px at 85% 20%, rgba(122,31,61,.10), transparent 60%), #0f0b12}
    .figure.poster{aspect-ratio:2/3}
    .figure.square{aspect-ratio:1/1}
    .figure>img{position:absolute; inset:0; width:100%; height:100%; object-fit:contain; display:block}

    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .input{background:#110d13; color:var(--text); border:1px solid var(--stroke); border-radius:10px; padding:8px 10px; outline:none}
    .badge{padding:4px 8px; border:1px solid var(--stroke); border-radius:999px; color:var(--muted); font-size:12px; background:#17111a}
    .link{color:var(--link); text-decoration:none}
    .link:hover{text-decoration:underline}
    .hidden{display:none}

    /* â€”â€” å¼•æ–‡å’’è¯­ï¼šé»˜è®¤å®Œå…¨èå…¥ï¼Œåªæœ‰ hover æ‰å¾®å…‰ â€”â€” */
    .incant-wrap{width:100%}
    .incant-wrap .divider{height:1px; width:100%; background:linear-gradient(90deg, transparent, rgba(214,191,129,.65), transparent); opacity:.85; margin:2px 0 8px 0}
    .incant-wrap .divider.bottom{margin:8px 0 2px 0}
    .spell{line-height:1.55; color:var(--muted); user-select:none; -webkit-user-select:none; text-align:left}
    .spell .hot{color:inherit; cursor:pointer; font-weight:inherit; text-decoration:none; padding:0 1px; border-radius:3px; transition:text-shadow .15s ease, filter .15s ease}
    .spell .hot:hover{text-shadow:0 0 6px rgba(214,191,129,.55), 0 0 16px rgba(128,34,66,.45); filter:brightness(1.07)}
    .spell .author{display:block; margin-top:6px; color:#cbbf9f; opacity:.9; font-size:12px; letter-spacing:.2px}
  </style>
</head>
<body>
  <div class="topbar">
    <button class="btn" id="addRecipe">ï¼‹ Fooooooood</button>
    <button class="btn" id="addMovie">ï¼‹ Go Theatre!</button>
    <button class="btn" id="addDrawer">ï¼‹ Wonderer</button>
    <button class="btn" id="addRead">ï¼‹ More read?</button>
    <button class="btn secondary" id="saveLayout">ğŸ’¾ Save layout</button>
    <button class="btn secondary" id="loadLayout">ğŸ“‚ Load layout</button>
    <button class="btn danger" id="resetLayout">Back2?</button>
    <span class="hint">é©¼èƒŒï¼Œåœ£è€…ï¼Œå’Œæ„šäººæ˜¯ä¸‹å¼¦æœˆã€‚</span>
  </div>
  <div id="board"></div>

  <script>
  ;(function(){
    const board = document.getElementById('board');
    const zStack = { top: 10, bump(el){ this.top += 1; el.style.zIndex = this.top; }};
    const STORAGE_KEY = 'widgets.layout.v1';
    const uid = ()=>'w_'+Math.random().toString(36).slice(2,9);

    // ---------- utils ----------
    function parseCSV(text, {header=true, skipEmptyLines=true}={}){
      const rows=[]; let cur=''; let row=[]; let q=false; let i=0;
      const pushCell=()=>{ row.push(cur); cur=''; };
      const pushRow=()=>{ rows.push(row); row=[]; };
      while(i<text.length){
        const ch=text[i];
        if(q){
          if(ch==='"'){ if(text[i+1]==='"'){ cur+='"'; i+=2; continue; } q=false; i++; }
          else { cur+=ch; i++; }
        }else{
          if(ch==='"'){ q=true; i++; }
          else if(ch===','){ pushCell(); i++; }
          else if(ch==='\n'){ pushCell(); pushRow(); i++; }
          else if(ch==='\r'){ if(text[i+1]==='\n') i++; pushCell(); pushRow(); i++; }
          else { cur+=ch; i++; }
        }
      }
      pushCell(); pushRow();
      if(rows.length && rows[rows.length-1].length===1 && rows[rows.length-1][0]==='') rows.pop();
      if(header){
        const head=rows.shift().map(h=>h.trim());
        const out=rows.map(r=>{const o={}; head.forEach((h,idx)=>o[h]=(r[idx]??'').trim()); return o;});
        return skipEmptyLines ? out.filter(o=>Object.values(o).some(v=>v!==''))
                              : out;
      }
      return skipEmptyLines ? rows.filter(r=>r.some(v=>v!=='')) : rows;
    }
    const validUrl = (u)=>{ try{ new URL(u); return true; }catch{ return false; } };

    // ---------- repo detection & GH configï¼ˆRead ç”¨ï¼‰ ----------
    function detectRepo(){
      const host = location.hostname;
      const path = location.pathname.replace(/^\/+/, '');
      if(/github\.io$/i.test(host)){
        const user = host.split('.')[0];
        const repo = path.split('/')[0] || '';
        if(user && repo) return {user, repo};
      }
      return null;
    }
    function qs(key, fallback=null){
      const v = new URLSearchParams(location.search).get(key);
      return v ? decodeURIComponent(v) : fallback;
    }
    const auto = detectRepo();
    const GH = {
      user:   qs('gh_user',   auto?.user || 'StellaWQL'),
      repo:   qs('gh_repo',   auto?.repo || 'recipes-widget'),
      branch: qs('gh_branch', 'practice'),
      path:   qs('gh_path',   'data/books'),
    };

    // ---------- Widget shell ----------
    function createWidget({type,title,x=120,y=120,w=360,h=null,state={}}){
      const id = uid();
      const root = document.createElement('div');
      root.className = 'widget resizable';
      root.tabIndex = 0;
      root.style.left = x+'px';
      root.style.top  = y+'px';
      if(w) root.style.width = w+'px';
      if(h) root.style.height = h+'px';
      root.dataset.id = id; root.dataset.type = type;
      zStack.bump(root);

      root.innerHTML = `
        <div class="w-header" data-draghandle>
          <div class="w-title" data-title>${title}</div>
        </div>
        <div class="w-body"></div>
        <div class="w-footer"></div>
      `;

      const header = root.querySelector('[data-draghandle]');
      const titleEl = root.querySelector('[data-title]');
      const body = root.querySelector('.w-body');

      // æ‹–æ‹½
      let drag = {on:false, dx:0, dy:0, moved:false, startX:0, startY:0};
      header.addEventListener('mousedown', (e)=>{
        drag.on=true; drag.moved=false;
        header.style.cursor='grabbing'; zStack.bump(root);
        drag.dx=e.clientX-root.offsetLeft; drag.dy=e.clientY-root.offsetTop;
        drag.startX = e.clientX; drag.startY = e.clientY;
        e.preventDefault();
      });
      window.addEventListener('mousemove', (e)=>{
        if(!drag.on) return;
        const nx = Math.max(0, Math.min(window.innerWidth - root.offsetWidth, e.clientX - drag.dx));
        const ny = Math.max(48, Math.min(window.innerHeight - 40, e.clientY - drag.dy));
        if(Math.hypot(e.clientX - drag.startX, e.clientY - drag.startY) > 4) drag.moved = true;
        root.style.left = nx+'px'; root.style.top = ny+'px';
      });
      window.addEventListener('mouseup', ()=>{
        if(drag.on){ drag.on=false; header.style.cursor='grab'; saveLayout(); }
      });
      // ç‚¹å‡»æ ‡é¢˜ = å…³é—­ï¼ˆæœªæ‹–åŠ¨æ—¶ï¼‰
      titleEl.addEventListener('click', ()=>{ if(!drag.moved){ root.remove(); saveLayout(); } });
      root.addEventListener('dblclick', ()=>{ zStack.bump(root); });

      board.appendChild(root);
      return { id, root, body, state };
    }

    // ---------- å¼•æ–‡ç»„ä»¶ï¼šä¸Šã€ä¸‹é‡‘çº¿ï¼›parts ä¸­ hot=true çš„è¯å¯ç‚¹ ----------
    function makeIncantation(container, {parts, author}){
      const wrap = document.createElement('div');
      wrap.className = 'incant-wrap';

      const top = document.createElement('div');
      top.className = 'divider';
      const bottom = document.createElement('div');
      bottom.className = 'divider bottom';

      const line = document.createElement('div');
      line.className = 'spell';

      parts.forEach((p,i)=>{
        const span = document.createElement('span');
        span.textContent = p.text;
        if(p.hot){
          span.className = 'hot';
          if(typeof p.onClick === 'function'){
            span.addEventListener('click', (e)=>{ e.stopPropagation(); p.onClick(); });
          }
        }
        line.appendChild(span);
        if(i !== parts.length-1) line.append(' ');
      });

      if(author){
        const au = document.createElement('span');
        au.className = 'author';
        au.textContent = `â€” ${author}`;
        line.appendChild(au);
      }

      wrap.appendChild(top);
      wrap.appendChild(line);
      wrap.appendChild(bottom);
      container.appendChild(wrap);
      return wrap;
    }

    // ---------- Recipe ----------
    async function RecipeWidget(opts={}){
      const w = createWidget({type:'recipe', title:'ğŸ³ Recipe', x:140, y:120, ...opts});
      w.body.innerHTML = `
        <div class="grid">
          <div class="row" data-incant></div>
          <div class="grid">
            <a class="figure square" data-link target="_blank" rel="noopener noreferrer">
              <img data-img alt="recipe image" />
            </a>
            <div class="row">
              <strong data-title>å‡†å¤‡ä¸­â€¦</strong>
            </div>
            <div class="row" data-issues></div>
          </div>
        </div>`;
      const el = {
        incant: w.body.querySelector('[data-incant]'),
        title: w.body.querySelector('[data-title]'),
        img: w.body.querySelector('[data-img]'),
        link: w.body.querySelector('[data-link]'),
        issues: w.body.querySelector('[data-issues]')
      };
      async function ensureData(){
        if(w.state.rows?.length) return w.state.rows;
        const CSV_PATH = 'data/atk_recipes_all.csv';
        const res = await fetch(`${CSV_PATH}?t=${Date.now()}`, {cache:'no-store'});
        if(!res.ok) throw new Error('CSV åŠ è½½å¤±è´¥: '+res.status);
        const text = await res.text();
        const rows = parseCSV(text, {header:true, skipEmptyLines:true}).map(r=>({
          title:(r.title||r.Title||r.name||'').trim(),
          image_url:(r.image_url||r.image||r.img||'').trim(),
          recipe_url:(r.recipe_url||r.url||r.link||'').trim()
        })).filter(r=>r.title && (r.image_url||r.recipe_url));
        if(!rows.length) throw new Error('CSV æ²¡æœ‰æœ‰æ•ˆè¡Œ');
        w.state.rows = rows; return rows;
      }
      function render(r){
        el.title.textContent = r.title || 'æœªå‘½å';
        const imgOk = r.image_url && (()=>{ try{ new URL(r.image_url); return true;}catch{return false;} })();
        const linkOk= r.recipe_url && (()=>{ try{ new URL(r.recipe_url); return true;}catch{return false;} })();
        el.img.src = imgOk? r.image_url : '';
        el.link.href = linkOk? r.recipe_url : '#';
        const issues=[]; if(!imgOk) issues.push('å›¾ç‰‡æ— æ•ˆ'); if(!linkOk) issues.push('é“¾æ¥æ— æ•ˆ');
        el.issues.innerHTML = issues.map(s=>`<span class="badge">${s}</span>`).join('');
      }
      function pick(){
        const a=w.state.rows; if(!a?.length) return;
        let i; do{ i=Math.floor(Math.random()*a.length) }while(a.length>1 && i===w.state.last);
        w.state.last=i; render(a[i]); saveLayout();
      }

      makeIncantation(el.incant, {
        parts:[
          {text:'Et', hot:false},
          {text:'luna', hot:false},
          {text:'phase', hot:true, onClick:()=> pick()},
          {text:'XI', hot:false}
        ],
        author:''
      });

      try{ await ensureData(); pick(); }catch(e){ el.issues.innerHTML=`<span class="badge">${String(e.message||e)}</span>`; }
      return w;
    }

    // ---------- Movieï¼ˆéšè—è§¦å‘è¯ = ç¬¬ä¸€ä¸ª amaviï¼‰ ----------
    async function MovieWidget(opts={}){
      const w = createWidget({type:'movie', title:'ğŸ¬ Movie', x:360, y:180, ...opts});
      w.body.innerHTML = `
        <div class="grid">
          <div class="row" data-incant></div>
          <div class="grid">
            <a class="figure poster" data-link target="_blank" rel="noopener noreferrer">
              <img data-img alt="movie poster" />
            </a>
            <div class="row">
              <strong data-title>å‡†å¤‡ä¸­â€¦</strong>
              <span class="badge" data-year></span>
              <span class="badge" data-score></span>
            </div>
            <div class="row" data-issues></div>
          </div>
        </div>`;
      const el = {
        incant:w.body.querySelector('[data-incant]'),
        img:w.body.querySelector('[data-img]'),
        link:w.body.querySelector('[data-link]'),
        title:w.body.querySelector('[data-title]'),
        year:w.body.querySelector('[data-year]'),
        score:w.body.querySelector('[data-score]'),
        issues:w.body.querySelector('[data-issues]'),
      };
      const parseYear = (d)=>{
        if(!d) return '';
        const m4 = String(d).match(/(19|20)\d{2}/); if(m4) return m4[0];
        const m2 = String(d).match(/(\d{2})(?!.*\d)/);
        if(m2){ const yy = parseInt(m2[1],10); return String(yy >= 30 ? 1900+yy : 2000+yy); }
        return '';
      };
      async function ensureData(){
        if(w.state.rows?.length) return w.state.rows;
        const candidates = w.state.candidates || ['data/movies.csv','movies.csv'];
        let rows=null;
        for(const p of candidates){
          try{
            const res = await fetch(`${p}?t=${Date.now()}`, {cache:'no-store'});
            if(!res.ok) continue;
            const txt  = await res.text();
            const arr  = parseCSV(txt,{header:true,skipEmptyLines:true}).map(r=>{
              const t   = (r.title||r.name||'').trim();
              const rd  = (r.release_date||r.date||'').trim();
              const ms  = (r.metascore||r.score||r.metascore_w||'').toString().trim();
              const img = (r.poster_url||r.image_url||r.poster||'').trim();
              const url = (r.url||r.link||r.movie_url||'').trim();
              return { title:t, release_date:rd, metascore:ms, poster_url:img, url };
            }).filter(o=> o.title && (o.poster_url || o.url));
            if(arr.length){ rows=arr; break; }
          }catch{}
        }
        if(!rows){ throw new Error('æ‰¾ä¸åˆ°å¯ç”¨çš„ movies CSV'); }
        w.state.rows = rows;
        return rows;
      }
      function render(r){
        el.title.textContent = r.title || 'æœªå‘½å';
        const y = parseYear(r.release_date); el.year.textContent = y ? y : 'å¹´ä»½æœªçŸ¥';
        const sc = parseInt(r.metascore,10); el.score.textContent = Number.isFinite(sc) ? `Metascore ${sc}` : 'æ— åˆ†æ•°';
        const hasImg = !!(r.poster_url && (()=>{ try{ new URL(r.poster_url); return true;}catch{return false;} })());
        el.img.src = hasImg ? r.poster_url : '';
        const target = r.url && r.url.trim() ? r.url.trim() : `https://www.google.com/search?q=${encodeURIComponent('site:metacritic.com '+(r.title||''))}`;
        el.link.href = target;
        const issues=[]; if(!hasImg) issues.push('å›¾ç‰‡æ— æ•ˆæˆ–ç¼ºå¤±'); if(!target) issues.push('æ— å¯ç”¨é“¾æ¥');
        el.issues.innerHTML = issues.map(s=>`<span class="badge">${s}</span>`).join('');
      }
      function pick(){
        const a=w.state.rows; if(!a?.length) return;
        let i; do{i=Math.floor(Math.random()*a.length)}while(a.length>1 && i===w.state.last);
        w.state.last = i; render(a[i]); saveLayout();
      }

      makeIncantation(el.incant, {
        parts:[
          {text:'Sero', hot:false},
          {text:'te', hot:false},
          {text:'amavi,', hot:true, onClick:()=> pick()},   // åªæœ‰è¿™ä¸ªå¯ç‚¹
          {text:'Pulchritudo', hot:false},
          {text:'tam', hot:false},
          {text:'antiqua', hot:false},
          {text:'et', hot:false},
          {text:'tam', hot:false},
          {text:'nova!', hot:false},
          {text:'Sero', hot:false},
          {text:'te', hot:false},
          {text:'amavi.', hot:false}
        ],
        author:'S. Augustine.'
      });

      try{ await ensureData(); pick(); }catch(e){ el.issues.innerHTML=`<span class="badge">${String(e.message||e)}</span>`; }
      return w;
    }

    // ---------- Readï¼ˆéšè—è§¦å‘è¯ = starsï¼›å»æ‰ .epubï¼›å°é¢ç‚¹å‡»æ‰“å¼€ reader.htmlï¼‰ ----------
    async function ReadWidget(opts={}){
      const w = createWidget({type:'read', title:'ğŸ“š Read', x:720, y:140, ...opts});
      w.body.innerHTML = `
        <div class="grid">
          <div class="row" data-incant></div>
          <div class="grid">
            <a class="figure poster" data-link target="_blank" rel="noopener noreferrer">
              <img data-img alt="book cover" />
            </a>
            <div class="row">
              <strong data-title>å‡†å¤‡ä¸­â€¦</strong>
            </div>
            <div class="row" data-issues></div>
          </div>
        </div>`;
      const el = {
        incant: w.body.querySelector('[data-incant]'),
        img:   w.body.querySelector('[data-img]'),
        link:  w.body.querySelector('[data-link]'),
        title: w.body.querySelector('[data-title]'),
        issues:w.body.querySelector('[data-issues]')
      };

      const CACHE_KEY = `reads.list.${GH.user}.${GH.repo}.${GH.branch}.${GH.path}`;
      const CACHE_MS  = 10*60*1000;

      async function listFromGitHub(){
        const now = Date.now();
        try{
          const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || 'null');
          if(cached && (now - cached.t < CACHE_MS)) return cached.list;
        }catch{}
        const apiUrl = `https://api.github.com/repos/${GH.user}/${GH.repo}/contents/${GH.path}?ref=${GH.branch}`;
        const res = await fetch(apiUrl, {cache:'no-store'});
        if(!res.ok){
          const txt = await res.text().catch(()=> '');
          throw new Error(`GitHub API ${res.status}: ${apiUrl}\n${txt.slice(0,200)}`);
        }
        const arr = await res.json();
        const files = arr.filter(it => it.type==='file' && /\.epub$/i.test(it.name));
        const list = files.map(it => ({ name: it.name, url: it.download_url }));
        localStorage.setItem(CACHE_KEY, JSON.stringify({t: now, list}));
        return list;
      }
      async function ensureList(){
        if(w.state.list?.length) return w.state.list;
        const list = await listFromGitHub();
        if(!list.length) throw new Error('æ²¡æœ‰å‘ç°ä»»ä½• EPUB');
        w.state.list = list;
        return list;
      }

      async function extractCoverUrl(epubUrl){
        if(!window.ePub){ throw new Error('epub.js æœªåŠ è½½'); }
        const book = ePub(epubUrl);
        await book.ready;
        let coverHref = await book.loaded.cover.catch(()=>null);
        if(!coverHref){
          const manifest = await book.loaded.manifest;
          const item = Object.values(manifest)
            .find(it => /cover/i.test(it.id||'') || /cover/i.test(it.href||'') || (it.properties||'').includes('cover-image'));
          coverHref = item ? item.href : null;
        }
        if(!coverHref) return null;
        const url = book.resources.get(coverHref) || (await book.archive.createUrl(coverHref, { base64:false }));
        return url || null;
      }

      const readerUrlFor = (epubUrl)=> `reader.html?${new URLSearchParams({ book: epubUrl }).toString()}`;

      async function render(item){
        const {name, url} = item;
        const display = (name||'æœªå‘½å').replace(/\.epub$/i,'');
        el.title.textContent = display;
        el.link.href = readerUrlFor(url);

        if(!w.state.covers) w.state.covers = {};
        if(w.state.covers[url]){ el.img.src = w.state.covers[url]; return; }

        el.img.removeAttribute('src');
        try{
          const cover = await extractCoverUrl(url);
          if(cover){ w.state.covers[url] = cover; el.img.src = cover; }
          else { el.issues.innerHTML=`<span class="badge">æœªæ‰¾åˆ°å°é¢</span>`; }
        }catch(e){
          el.issues.innerHTML=`<span class="badge">å°é¢è§£æå¤±è´¥ï¼ˆæ£€æŸ¥ JSZip/epub.js ä¸ CORSï¼‰</span>`;
          console.error(e);
        }
      }
      function pick(){
        const a = w.state.list; if(!a?.length) return;
        let i; do{ i = Math.floor(Math.random()*a.length); }while(a.length>1 && i===w.state.last);
        w.state.last = i; render(a[i]); saveLayout();
      }

      makeIncantation(el.incant, {
        parts:[
          {text:'The', hot:false},
          {text:'stars', hot:true, onClick:()=> pick()},
          {text:'are', hot:false},
          {text:'threshed,', hot:false},
          {text:'and', hot:false},
          {text:'the', hot:false},
          {text:'souls', hot:false},
          {text:'are', hot:false},
          {text:'threshed', hot:false},
          {text:'from', hot:false},
          {text:'their', hot:false},
          {text:'husks.', hot:false}
        ],
        author:'William Blake.'
      });

      try{ await ensureList(); pick(); }catch(e){ el.issues.innerHTML=`<span class="badge">${String(e.message||e)}</span>`; }
      return w;
    }

    // ---------- Card Drawer ----------
    function CardDrawer(opts={}){
      const w = createWidget({type:'drawer', title:'ğŸƒ Card Drawer', x:820, y:160, ...opts});
      w.state.deck = (opts.state && opts.state.deck) || [
        {title:'ä»Šæ—¥æƒŠå–œ', desc:'TBD'},
        {title:'å¥åº·æ‰“å¡', desc:'TBD'},
        {title:'ç”µå½±ä¹‹å¤œ', desc:'TBD'},
        {title:'æ•´ç†æ—¶é—´', desc:'TBD'},
        {title:'æ”¾æ¾ä¸€ä¸‹', desc:'TBD'}
      ];
      w.body.innerHTML = `
        <div class="grid">
          <div class="row">
            <button class="btn" data-draw>æŠ½ä¸€å¼ </button>
            <button class="btn secondary" data-peek>æŸ¥çœ‹å¡ç»„(${w.state.deck.length})</button>
          </div>
          <div class="grid" data-area>
            <div class="badge">ç‚¹â€œæŠ½ä¸€å¼ â€éšæœºå‡ºå¡</div>
          </div>
        </div>`;
      const area = w.body.querySelector('[data-area]');
      const renderCard = (c)=>{ area.innerHTML=''; const card=document.createElement('div'); card.style.border='1px solid var(--stroke)'; card.style.borderRadius='12px'; card.style.padding='10px'; card.style.background='#17111a'; card.innerHTML=`<strong>${c.title}</strong><div class="muted">${c.desc||''}</div>`; area.appendChild(card); };
      w.body.querySelector('[data-draw]').addEventListener('click',()=>{ const d=w.state.deck; const i=Math.floor(Math.random()*d.length); renderCard(d[i]); saveLayout(); });
      w.body.querySelector('[data-peek]').addEventListener('click',()=>{ area.innerHTML=''; w.state.deck.forEach(c=>{ const row=document.createElement('div'); row.className='row'; row.innerHTML=`<span class="badge">${c.title}</span><span class="muted">${c.desc||''}</span>`; area.appendChild(row); }); });
      return w;
    }

    // ---------- Layout persistence ----------
    function serialize(){
      const data=[]; document.querySelectorAll('.widget').forEach(el=>{
        const bodyHidden = el.querySelector('.w-body')?.classList.contains('hidden');
        data.push({ id: el.dataset.id, type: el.dataset.type, x: el.offsetLeft, y: el.offsetTop, w: el.offsetWidth, h: el.offsetHeight, minimized: !!bodyHidden, state: window.__widgetState?.[el.dataset.id] || {} });
      });
      return data;
    }
    function saveLayout(){ const data=serialize(); localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
    async function loadLayout(){
      const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return false;
      const arr = JSON.parse(raw);
      board.querySelectorAll('.widget').forEach(n=>n.remove());
      window.__widgetState = {};
      for(const w of arr){
        let inst;
        if(w.type==='recipe')      inst = await RecipeWidget({x:w.x,y:w.y,w:w.w,h:w.h,state:w.state});
        else if(w.type==='movie')  inst = await MovieWidget({x:w.x,y:w.y,w:w.w,h:w.h,state:w.state});
        else if(w.type==='drawer') inst = await CardDrawer({x:w.x,y:w.y,w:w.w,h:w.h,state:w.state});
        else if(w.type==='read')   inst = await ReadWidget({x:w.x,y:w.y,w:w.w,h:w.h,state:w.state});
        if(inst){
          window.__widgetState[inst.id] = inst.state;
          if(w.minimized){ inst.root.querySelector('.w-body').classList.add('hidden'); }
        }
      }
      return true;
    }

    // ---------- Toolbar ----------
    document.getElementById('addRecipe').addEventListener('click', async()=>{ const inst = await RecipeWidget(); (window.__widgetState||(window.__widgetState={}))[inst.id]=inst.state; saveLayout(); });
    document.getElementById('addMovie').addEventListener('click',  async()=>{ const inst = await MovieWidget();  (window.__widgetState||(window.__widgetState={}))[inst.id]=inst.state; saveLayout(); });
    document.getElementById('addDrawer').addEventListener('click', ()=>{ const inst = CardDrawer();              (window.__widgetState||(window.__widgetState={}))[inst.id]=inst.state; saveLayout(); });
    document.getElementById('addRead').addEventListener('click',   async()=>{ const inst = await ReadWidget();   (window.__widgetState||(window.__widgetState={}))[inst.id]=inst.state; saveLayout(); });
    document.getElementById('saveLayout').addEventListener('click', saveLayout);
    document.getElementById('loadLayout').addEventListener('click', ()=>{ loadLayout(); });
    document.getElementById('resetLayout').addEventListener('click', ()=>{ localStorage.removeItem(STORAGE_KEY); location.reload(); });

    // ---------- Boot ----------
    (async function boot(){
      const ok = await loadLayout();
      if(!ok){
        const a = await RecipeWidget({x:120,y:140});
        const b = await MovieWidget({x:520,y:120});
        const c = CardDrawer({x:820,y:160});
        const d = await ReadWidget({x:920,y:140});
        window.__widgetState = {[a.id]:a.state,[b.id]:b.state,[c.id]:c.state,[d.id]:d.state};
        saveLayout();
      }
    })();
  })();
  </script>
</body>
</html>

